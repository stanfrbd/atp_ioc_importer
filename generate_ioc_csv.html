<!-- Stanislas MEDRANO - CSIRT - 04/08/2021 -->

<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>CSV ATP IOC</title>

    <style>
        html {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #202228;
            color: #ABB2BF;
        }

        label {
            font-family: 'Consolas';
            font-size: 20px;
        }

        button {
            font-size: 14px;
        }

        .explanation {
            font-style: italic;
            font-size: 12px;
        }

        textarea {
            font-family: 'Consolas';
            font-size: 16px;
        }

        p {
            font-size: 22px;
        }

        h1 {
            color: orange;
        }

        .ignored_rows {
            color: red;
            background-color: white;
            font-family: "Consolas";
        }
    </style>
</head>



<body onload="set_dates();">

    <h1>Générer un CSV pour les IOC dans ATP</h1>

    <form action="javascript:;" onsubmit="generate_output(this)">

        <!-- IndicatorValue -->

        <p>Ajouter la liste d'éléments </p>
        <p class="explanation">Un élément par ligne - suppression automatique des espaces - ignore les lignes vides -
            détection automatique du IndicatorType</p>

        <label for="elements" hidden="true">elements</label>
        <textarea
            placeholder="Exemple : 111.111.111.111 ou 2021-05-24 14:24:06,186.97.172.178,2021-08-05,Telechargement TrickBot"
            id="elements" name="elements" cols="100" rows="10" required></textarea>

        <!-- ExpirationTime -->

        <label for="ExpirationTime" hidden="true">ExpirationTime</label>
        <p>ExpirationTime </p>
        <p class="explanation">Le ExpirationTime par défaut est "date actuelle + 6
            mois" - Attention format YYYY-MM-DD - si le format est incorrect, ATP rejettera le CSV.</p>

        <input type="text" id="ExpirationTime" name="ExpirationTime">

        <!-- Action -->

        <p>Action</p>

        <input type="radio" id="BlockAndRemediate" name="Action" value="BlockAndRemediate" required>
        <label for="BlockAndRemediate">BlockAndRemediate (pour les IP/domaines/URL l'Action sera uniquement
            Block)</label><br>

        <input type="radio" id="Audit" name="Action" value="Audit" required>
        <label for="Audit">Audit</label><br>

        <input type="radio" id="Allowed" name="Action" value="Allowed" required>
        <label for="Allowed">Allowed</label><br>

        <!-- Severity -->

        <p>Severity</p>

        <input type="radio" id="Informational" name="Severity" value="Informational" required>
        <label for="Informational">Informational</label><br>

        <input type="radio" id="Low" name="Severity" value="Low" required>
        <label for="Low">Low</label><br>

        <input type="radio" id="Medium" name="Severity" value="Medium" required>
        <label for="Medium">Medium</label><br>

        <input type="radio" id="High" name="Severity" value="High" required>
        <label for="High">High</label><br>

        <!-- Description -->

        <p>Description</p>
        <p class="explanation">La Description par défaut est "date actuelle + _Prevention_ANSSI" afin de pouvoir se
            repérer.</p>

        <input type="text" size="100" id="Desc" name="Description" required>

        <br>
        <br>
        <button type="submit">
            Télécharger le CSV
        </button>

    </form>

    <div id="result"></div>
    <div id="ignored_rows" class="ignored_rows"></div>


    <script>
        let IndicatorType = ""
        let IndicatorValue = ""
        let ExpirationTime = ""
        let Action = ""
        let Severity = ""
        let Description = ""
        let GenerateAlert = "true" // we will set an alert by default
        let SEP = ","

        let IgnoredRows = 0
        let TotalRows = 0

        let ignored = ""

        // Set ATP Template Headers
        let csv = "IndicatorType" + SEP + "IndicatorValue" + SEP + "ExpirationTime" + SEP + "Action" + SEP +
            "Severity" + SEP + "Title" + SEP + "Description" + SEP + "RecommendedActions" + SEP + "Scope/DeviceGroups" +
            SEP + "Category" + SEP + "MitreTechniques" + SEP + "GenerateAlert" + "\n"

        function set_dates() {
            let d = new Date()
            d.setMonth(d.getMonth() + 6);
            let dd = String(d.getDate()).padStart(2, '0')
            let mm = String(d.getMonth() + 1).padStart(2, '0') // January is 0!
            let yyyy = d.getFullYear()
            exp6months = yyyy + '-' + mm + '-' + dd

            let d2 = new Date()
            let dd2 = String(d2.getDate()).padStart(2, '0')
            let mm2 = String(d2.getMonth() + 1).padStart(2, '0') // January is 0!
            let yyyy2 = d2.getFullYear()
            today = yyyy2 + '-' + mm2 + '-' + dd2

            // Debug
            console.log(today) // Today
            console.log(exp6months) // 6 months later

            document.getElementById("ExpirationTime").value = exp6months
            document.getElementById("Desc").value = today + "_Prevention_ANSSI"
        }

        function check_data_type(val) {

            const regex_ipv4 =
                /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/

            const regex_ipv6 =
                /^((?:[0-9A-Fa-f]{1,4}))((?::[0-9A-Fa-f]{1,4}))*::((?:[0-9A-Fa-f]{1,4}))((?::[0-9A-Fa-f]{1,4}))*|((?:[0-9A-Fa-f]{1,4}))((?::[0-9A-Fa-f]{1,4})){7}$/

            const regex_url =
                /((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=\+\$,\w]+@)?[A-Za-z0-9.-]+|(?:www.|[-;:&=\+\$,\w]+@)[A-Za-z0-9.-]+)((?:\/[\+~%\/.\w-_]*)?\??(?:[-\+=&;%@.\w_]*)#?(?:[\w]*))?)/

            const regex_domain = /^[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9](?:\.[a-zA-Z0-9-]{2,})+$/
            // old : /^[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9](?:\.[a-zA-Z]{2,})+$/

            const regex_sha1 = /^[a-f0-9]{40}$/gi

            const regex_sha256 = /^[a-f0-9]{64}$/gi

            const regex_md5 = /^[a-f0-9]{32}$/


            if (regex_ipv4.test(arguments[0]) && arguments[0].includes(".") || regex_ipv6.test(arguments[0]) &&
                arguments[0].includes(":")) {
                return "IpAddress"
            } else if (regex_url.test(arguments[0]) && !arguments[0].includes("\"")) {
                return "Url"
            } else if (regex_sha256.test(arguments[0])) {
                return "FileSha256"
            } else if (regex_domain.test(arguments[0])) {
                return "DomainName"
            } else if (regex_sha1.test(arguments[0])) {
                return "FileSha1"
            } else if (regex_md5.test(arguments[0])) {
                return "FileMd5"
            }
            else {
                return "Unknown"
            }

        }


        function generate_output() {

            ExpirationTime = document.getElementById("ExpirationTime").value.trim()

            const formData = new FormData(document.querySelector('form'))
            for (let pair of formData.entries()) {

                // Debug
                // console.log(pair[0] + ': ' + pair[1]);
                if (pair[0] == "Action") {
                    Action = pair[1]
                } else if (pair[0] == "Severity") {
                    Severity = pair[1]
                } else if (pair[0] == "Description") {
                    Description = pair[1]
                }
            }

            // Debug
            console.log("CSV Look:")
            console.log(
                "IndicatorType" + SEP + "IndicatorValue" + SEP + "ExpirationTime" + SEP + "Action" + SEP +
                "Severity" + SEP + "Title" + SEP + "Description" + SEP + "RecommendedActions" + SEP +
                "Scope/DeviceGroups" +
                SEP + "Category" + SEP + "MitreTechniques" + SEP + "GenerateAlert"
            )

            let lines = document.getElementById("elements").value.split('\n')

            for (let i = 0; i < lines.length; i++) {

                let row = lines[i].trim()

                // Has a separator
                if (row.includes(",") || row.includes(";")) {
                    
                    // if ';' instead of ','
                    row = row.replaceAll(";", ",")

                    let tab = row.split(",")

                    for (elt in tab) {
                        IndicatorType = check_data_type(tab[elt])
                        if (IndicatorType != "Unknown") {
                            IndicatorValue = tab[elt]
                            break
                        }
                    }
                }
                // Raw data
                else if (!row.includes(",")) {
                    IndicatorType = check_data_type(row)

                    if (IndicatorType == "Unknown" && row != "") {
                        IgnoredRows++
                        // Debug
                        console.log("Ignored: " + row)
                        ignored += row + "<br>"
                    } else {
                        IndicatorValue = row
                    }
                }

                if (IndicatorValue != "" && IndicatorType != "Unknown") {

                    if ((IndicatorType == "IpAddress" || IndicatorType == "Url" || IndicatorType == "DomainName") &&
                        Action == "BlockAndRemediate") {
                        Action = "Block"
                    }
                    str = IndicatorType + SEP + IndicatorValue + SEP + ExpirationTime + SEP + Action + SEP + Severity +
                        SEP +
                        Description + "_" + IndicatorType + SEP + Description + "_" + IndicatorType + SEP + SEP + SEP + SEP + SEP + GenerateAlert

                        // Ajout de l'IndicatorType  dans la Description ET le titre pour facilier la lecture des alertes ATP.

                    // Debug
                    console.log(str)

                    // append to csv
                    csv += str
                    csv += "\n"

                    TotalRows++

                    // clearing
                    // IndicatorValue = ""
                }
            }

            // display the created CSV data on the web browser   
            // document.write(csv);

            let hiddenElement = document.createElement('a')
            hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv)
            hiddenElement.target = '_blank';

            // Provide the name for the CSV file to be downloaded  
            hiddenElement.download = 'ioc_to_import.csv'
            hiddenElement.click()

            // Information about loaded lines
            document.getElementById("result").innerHTML += "<p> Nombre de lignes chargées : " + TotalRows + "</p>"
            document.getElementById("result").innerHTML += "<p> Nombre de lignes non reconnues (donc ignorées) : " +
                IgnoredRows + "</p>"
            document.getElementById("ignored_rows").innerHTML += "<p>" + ignored + "</p>"

            // Add refresh button
            document.getElementById("result").innerHTML +=
                "<button onclick=\"history.go(0)\" value=\"Refresh\"> Recommencer </button>"


        };
    </script>


</body>

</html>